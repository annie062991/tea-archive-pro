<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>Annie çš„ GitHub Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 32px;
      line-height: 1.7;
    }
    pre {
      background: #f6f8fa;
      padding: 16px;
      border-radius: 12px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ‰ æˆåŠŸäº†</h1>
  <p>å¦‚æœä½ çœ‹åˆ°é€™è¡Œå­—ï¼Œä»£è¡¨ GitHub Pages å·²ç¶“æº–å‚™å¥½äº†ã€‚</p>

  <pre><code>
import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection } from 'firebase/firestore';
import { 
  Calendar as CalendarIcon, 
  BarChart3, 
  ChevronLeft, 
  ChevronRight, 
  Plus, 
  Trash2, 
  ArrowLeft,
  Trophy,
  Leaf,
  Store,
  Delete,
  ChevronDown,
  Activity,
  Loader2,
  Coffee,
  Coins,
  Gift,
  Plane,
  Gamepad2,
  TrendingUp,
  X,
  Settings2,
  RotateCcw
} from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'milk-tea-pro-ultimate';

const SUGAR_OPTIONS = ["ç„¡ç³–", "ä¸€åˆ†", "å¾®ç³–", "åŠç³–", "å°‘ç³–", "å…¨ç³–", "å›ºå®š"];
const ICE_OPTIONS = ["å»å†°", "å¾®å†°", "å°‘å†°", "æ­£å¸¸", "å¸¸æº«", "ç†±", "å›ºå®š"];

const getShopColorStyles = (shopName) => {
  if (!shopName) return { bg: '#FDF8F3', text: '#432818', border: '#AF8F6F' };
  let hash = 0;
  for (let i = 0; i < shopName.length; i++) {
    hash = shopName.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash % 360);
  const s = 65 + (Math.abs(hash % 25));
  const l = 82 - (Math.abs(hash % 10));
  return {
    bg: `hsla(${h}, ${s}%, ${l}%, 1)`,
    border: `hsla(${h}, ${s}%, ${l - 30}%, 1)`,
    text: `hsla(${h}, ${s}%, 20%, 1)`
  };
};

export default function App() {
  const [now] = useState(new Date());
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [records, setRecords] = useState({});
  const [ignoredItems, setIgnoredItems] = useState([]); 
  const [editMemoryMode, setEditMemoryMode] = useState(false); 
  const [showRestoreModal, setShowRestoreModal] = useState(false); 

  const [curY, setCurY] = useState(now.getFullYear());
  const [curM, setCurM] = useState(now.getMonth());
  const [view, setView] = useState('calendar'); 
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedDate, setSelectedDate] = useState("");
  const [tempList, setTempList] = useState([]);
  const [activeInputIdx, setActiveInputIdx] = useState(0);
  const [showKeypad, setShowKeypad] = useState(null);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth error", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubRecords = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'drink_records'), (snap) => {
      const data = {};
      snap.forEach(d => { 
        const list = d.data().list || [];
        if (list.length > 0) data[d.id] = list; 
      });
      setRecords(data);
      setLoading(false);
    }, (err) => setLoading(false));

    const unsubIgnored = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'ignored'), (doc) => {
      if (doc.exists()) setIgnoredItems(doc.data().items || []);
    });
    return () => { unsubRecords(); unsubIgnored(); };
  }, [user]);

  const stats = useMemo(() => {
    const res = {
      m: { spend: 0, count: 0, shops: {}, configs: {} },
      y: { spend: 0, count: 0, uniqueShops: new Set(), ecoCount: 0, shops: {}, configs: {} },
      dayDist: [0,0,0,0,0,0,0],
      allHistory: []
    };

    const sortedDateKeys = Object.keys(records).sort();
    sortedDateKeys.forEach((ds) => {
      const items = records[ds];
      const [y, m, d_val] = ds.split('-').map(Number);
      const d = new Date(y, m - 1, d_val);
      const isCurY = d.getFullYear() === curY;
      const isCurM = isCurY && d.getMonth() === curM;
      
      items.forEach(r => {
        let price = parseFloat(r.price) || 0;
        let finalPrice = r.isGift ? 0 : (r.isEco ? Math.max(0, price - 5) : price);
        const shop = r.shop || "æœªçŸ¥";
        const item = r.item || "æœªå¡«å¯«";
        const sugar = r.sugar || "ç„¡ç³–";
        const ice = r.ice || "å»å†°";
        const configKey = `${shop} ${item} (${sugar}/${ice})`;
        
        res.allHistory.push({ ...r, dateStr: ds });
        if (!isNaN(d.getDay())) res.dayDist[d.getDay()]++;
        
        if (isCurY) {
          res.y.count++; 
          res.y.spend += finalPrice; 
          res.y.uniqueShops.add(shop);
          if (r.isEco) res.y.ecoCount++;
          res.y.shops[shop] = (res.y.shops[shop] || 0) + 1;
          res.y.configs[configKey] = (res.y.configs[configKey] || 0) + 1;
        }
        if (isCurM) {
          res.m.count++; 
          res.m.spend += finalPrice;
          res.m.shops[shop] = (res.m.shops[shop] || 0) + 1;
          res.m.configs[configKey] = (res.m.configs[configKey] || 0) + 1;
        }
      });
    });
    
    let maxStreak = 0;
    const sortedDates = Object.keys(records).sort();
    if (sortedDates.length > 0) {
      const msArr = Array.from(new Set(sortedDates.map(ds => {
        const [y,m,d] = ds.split('-').map(Number);
        return new Date(y, m-1, d).getTime();
      }))).sort((a,b) => a-b);
      let temp = 1;
      for (let i = 1; i < msArr.length; i++) {
        if (Math.round((msArr[i] - msArr[i-1])/86400000) === 1) temp++;
        else { maxStreak = Math.max(maxStreak, temp); temp = 1; }
      }
      maxStreak = Math.max(maxStreak, temp);
    }

    const getTop = (obj, limit = 5) => Object.entries(obj).sort((a,b) => b[1]-a[1]).slice(0, limit);
    
    const shopCounts = {};
    res.allHistory.forEach(h => { 
      if(h.shop && !ignoredItems.includes(h.shop)) {
        shopCounts[h.shop] = (shopCounts[h.shop] || 0) + 1;
      }
    });
    const topShops = Object.entries(shopCounts).sort((a,b)=>b[1]-a[1]).slice(0,8).map(e=>e[0]);

    return {
      maxStreak,
      uniqueCount: res.y.uniqueShops.size,
      yEcoCount: res.y.ecoCount,
      yTotalCount: res.y.count,
      ecoRate: res.y.count > 0 ? (res.y.ecoCount / res.y.count) * 100 : 0,
      dayDist: res.dayDist,
      ySpend: res.y.spend, 
      yCount: res.y.count,
      mSpend: res.m.spend, 
      mCount: res.m.count,
      mTopShops: getTop(res.m.shops, 3),
      mTopConfigs: getTop(res.m.configs, 3),
      yTopShops: getTop(res.y.shops, 5),
      yTopConfigs: getTop(res.y.configs, 5),
      ticketCount: (res.y.spend / 15000).toFixed(1),
      switchCount: (res.y.spend / 12000).toFixed(1),
      topShops,
      allHistory: res.allHistory
    };
  }, [records, curY, curM, ignoredItems]);

  const handleSave = async () => {
    if (!user) return;
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'drink_records', selectedDate), { list: tempList });
    setIsModalOpen(false);
  };

  const handleIgnore = async (id) => {
    if (!user) return;
    const newIgnored = [...ignoredItems, id];
    setIgnoredItems(newIgnored);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'ignored'), { items: newIgnored });
  };

  const handleRestoreItem = async (id) => {
    if (!user) return;
    const newIgnored = ignoredItems.filter(i => i !== id);
    setIgnoredItems(newIgnored);
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'ignored'), { items: newIgnored });
  };

  const findLastConfigForItem = (shop, item, price) => {
    const history = [...stats.allHistory].reverse();
    const match = history.find(h => h.shop === shop && h.item === item && h.price == price);
    return match ? { sugar: match.sugar, ice: match.ice } : { sugar: "ç„¡ç³–", ice: "å»å†°" };
  };

  if (loading) return <div className="flex h-screen items-center justify-center bg-[#F7F1EA]"><Loader2 className="animate-spin text-[#8B5E3C]" size={60} /></div>;

  return (
    <div className="flex h-screen flex-col bg-[#F7F1EA] text-[#432818] font-sans overflow-hidden safe-area-inset">
      <header className="bg-[#FDFCFB] pt-12 pb-6 px-5 rounded-b-[2.5rem] shadow-md z-40 shrink-0 border-b border-[#EADBC8]">
        <div className="flex items-start justify-between w-full">
          <div className="flex-1 text-left">
            <h1 className="text-xl font-black text-[#432818]">æ‰‹æ–ç´€éŒ„</h1>
            <p className="text-[9px] font-black text-[#8B5E3C] mt-0.5 tracking-widest uppercase">Tea Archive Pro</p>
          </div>
          <div className="flex-1 flex flex-col items-center border-x border-[#F7F1EA]">
            <div className="flex items-baseline gap-0.5">
              <span className="text-3xl font-black text-[#8B5E3C]">{view === 'calendar' ? stats.mCount : stats.yCount}</span>
              <span className="text-[10px] font-black opacity-30">æ¯</span>
            </div>
            <p className="text-[9px] font-black text-[#8B5E3C] mt-0.5">{view === 'calendar' ? 'æœ¬æœˆé£²ç”¨' : 'å¹´åº¦é£²ç”¨'}</p>
          </div>
          <div className="flex-1 flex flex-col items-end">
            <div className="flex items-baseline gap-0.5">
              <span className="text-3xl font-black text-[#8B5E3C]">{view === 'calendar' ? stats.mSpend : stats.ySpend}</span>
              <span className="text-[10px] font-black opacity-30">å…ƒ</span>
            </div>
            <p className="text-[9px] font-black text-[#8B5E3C] mt-0.5 uppercase">{view === 'calendar' ? 'æœ¬æœˆèŠ±è²»' : 'å¹´åº¦èŠ±è²»'}</p>
          </div>
        </div>
      </header>

      <main className="flex-1 overflow-y-auto no-scrollbar pb-24">
        {view === 'calendar' ? (
          <div className="p-2 sm:p-4 bg-[#FDFCFB] shadow-lg border-b-2 border-[#EADBC8] min-h-full">
            <div className="flex justify-between items-center mb-4 px-2 mt-2">
              <button onClick={() => { let m = curM-1; if(m<0){m=11; setCurY(curY-1);} setCurM(m); }} className="p-2.5 bg-[#F7F1EA] rounded-xl border border-[#EADBC8]"><ChevronLeft size={18}/></button>
              <h2 className="font-black text-lg">{curY}å¹´ {curM+1}æœˆ</h2>
              <button onClick={() => { let m = curM+1; if(m>11){m=0; setCurY(curY+1);} setCurM(m); }} className="p-2.5 bg-[#F7F1EA] rounded-xl border border-[#EADBC8]"><ChevronRight size={18}/></button>
            </div>
            <div className="grid grid-cols-7 gap-1"> 
              {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w => <div key={w} className="text-center text-[11px] font-black text-[#8B5E3C] pb-1">{w}</div>)}
              {(() => {
                const first = new Date(curY, curM, 1).getDay();
                const totalDays = new Date(curY, curM+1, 0).getDate();
                let cells = [];
                for(let i=0; i<first; i++) cells.push(<div key={`e-${i}`} />);
                for(let d=1; d<=totalDays; d++) {
                  const ds = `${curY}-${curM+1}-${d}`;
                  const list = records[ds] || [];
                  const isToday = ds === `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
                  cells.push(
                    <div key={ds} onClick={() => { setSelectedDate(ds); setTempList([...list]); setIsModalOpen(true); }} 
                      className={`min-h-[115px] p-1 rounded-lg border flex flex-col transition-all relative ${isToday ? 'border-[#8B5E3C] bg-[#F7F1EA] shadow-sm z-10' : list.length > 0 ? 'bg-[#FDF8F3] border-[#EADBC8]' : 'bg-[#F0E6DB]/10 border-transparent opacity-50'}`}>
                      <span className={`text-[10px] font-black mb-1 px-1.5 py-0.5 rounded-md w-fit ${isToday ? 'bg-[#8B5E3C] text-white' : list.length > 0 ? 'bg-[#AF8F6F] text-white' : 'text-[#AF8F6F]'}`}>{d}</span>
                      <div className="space-y-1 flex-1 overflow-y-auto no-scrollbar">
                        {list.map((item, idx) => {
                          const style = getShopColorStyles(item.shop);
                          return (
                            <div key={idx} style={{backgroundColor: style.bg, borderColor: style.border, color: style.text}} className="w-full p-1 border-l-[3px] rounded shadow-sm text-[8px] font-bold leading-tight flex flex-col">
                              <span className="truncate">{item.shop}</span>
                              {item.item && <span className="opacity-70 truncate text-[7px]">{item.item}</span>}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                }
                return cells;
              })()}
            </div>
          </div>
        ) : (
          <div className="p-6 space-y-6">
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-[#FDFCFB] p-5 rounded-3xl border border-[#EADBC8] shadow-sm flex flex-col items-center">
                <Trophy className="text-yellow-500 mb-1" size={24} />
                <p className="text-[9px] font-black text-[#8B5E3C] uppercase">æœ€é«˜é€£çºŒ</p>
                <p className="text-2xl font-black">{stats.maxStreak} <span className="text-xs opacity-30">å¤©</span></p>
              </div>
              <div className="bg-[#FDFCFB] p-5 rounded-3xl border border-[#EADBC8] shadow-sm flex flex-col items-center">
                <Store className="text-[#8B5E3C] mb-1" size={24} />
                <p className="text-[9px] font-black text-[#8B5E3C] uppercase">å¹´åº¦åº—å®¶</p>
                <p className="text-2xl font-black">{stats.uniqueCount} <span className="text-xs opacity-30">é–“</span></p>
              </div>
            </div>

            <section className="bg-[#FDFCFB] rounded-[2rem] p-6 border border-[#EADBC8] shadow-sm space-y-5">
              <div className="flex items-center gap-3 border-b border-[#F7F1EA] pb-3">
                <Activity className="text-[#8B5E3C]" size={20}/>
                <h3 className="font-black text-base">é€±é£²ç”¨ç¿’æ…£</h3>
              </div>
              <div className="flex items-end justify-between h-28 px-1 pt-4">
                {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((label, idx) => {
                  const val = stats.dayDist[idx];
                  const maxVal = Math.max(...stats.dayDist, 1);
                  const height = (val / maxVal) * 100;
                  return (
                    <div key={label} className="flex flex-col items-center gap-1.5 flex-1">
                      <span className={`text-[9px] font-black ${val > 0 ? 'text-[#8B5E3C]' : 'text-transparent'}`}>{val}</span>
                      <div className="w-5 bg-[#F7F1EA] rounded-full flex flex-col justify-end overflow-hidden h-20 border border-[#EADBC8]/30">
                        <div style={{ height: `${height}%` }} className="w-full bg-[#8B5E3C] rounded-t-full transition-all duration-700"></div>
                      </div>
                      <span className="text-[10px] font-black text-[#AF8F6F]">{label}</span>
                    </div>
                  );
                })}
              </div>
            </section>

            <section className="bg-[#FDFCFB] rounded-[2.5rem] p-7 border border-[#EADBC8] shadow-sm space-y-5">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2.5">
                  <div className="bg-green-100 p-2 rounded-xl"><Leaf className="text-green-600" size={20} /></div>
                  <h3 className="font-black text-base text-[#432818]">ä»Šå¤©ä¹Ÿå¾ˆç’°ä¿å–”</h3>
                </div>
                <div className="text-right">
                  <span className="text-xs font-black opacity-30 block">ç´¯è¨ˆçœä¸‹</span>
                  <span className="text-xl font-black text-green-600">${stats.yEcoCount * 5}</span>
                </div>
              </div>
              <div className="space-y-2">
                <div className="flex justify-between text-[10px] font-black uppercase tracking-widest text-[#8B5E3C]">
                  <span>ç’°ä¿æ¬¡æ•¸ï¼š{stats.yEcoCount} / {stats.yTotalCount}</span>
                  <span>é”æˆç‡ï¼š{Math.round(stats.ecoRate)}%</span>
                </div>
                <div className="h-4 bg-[#F7F1EA] rounded-full overflow-hidden border border-[#EADBC8]/30">
                  <div className="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all" style={{ width: `${stats.ecoRate}%` }}></div>
                </div>
              </div>
            </section>

            <section className="bg-[#FDFCFB] rounded-[2.5rem] p-7 border border-[#EADBC8] shadow-sm space-y-6">
              <div className="flex items-center gap-3 border-b border-[#F7F1EA] pb-4">
                <Coffee className="text-[#8B5E3C]" size={20}/>
                <h3 className="font-black text-lg">æœ¬æœˆæœ€æ„›ç´€éŒ„</h3>
              </div>
              <div className="space-y-6">
                <div>
                  <p className="text-[10px] font-black text-[#8B5E3C] uppercase mb-3 tracking-widest">æœ€æ„›åº—å®¶ TOP 3</p>
                  <div className="space-y-3">
                    {stats.mTopShops.map(([name, count], idx) => (
                      <div key={name} className="flex justify-between items-center bg-[#F7F1EA]/30 p-3 rounded-2xl">
                        <span className="text-sm font-bold">{idx+1}. {name}</span>
                        <span className="text-xs font-black text-[#8B5E3C]">{count} æ¬¡</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div>
                  <p className="text-[10px] font-black text-[#8B5E3C] uppercase mb-3 tracking-widest">æœ€æ„›çµ„åˆ TOP 3</p>
                  <div className="space-y-3">
                    {stats.mTopConfigs.map(([name, count], idx) => (
                      <div key={name} className="flex justify-between items-start bg-[#F7F1EA]/30 p-3 rounded-2xl">
                        <span className="text-xs font-bold leading-relaxed pr-2">{idx+1}. {name}</span>
                        <span className="text-[10px] font-black text-[#8B5E3C] shrink-0">{count} æ¬¡</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </section>

            <section className="bg-[#FDFCFB] rounded-[2.5rem] p-7 border border-[#EADBC8] shadow-sm space-y-6">
              <div className="flex items-center gap-3 border-b border-[#F7F1EA] pb-4">
                <TrendingUp className="text-[#8B5E3C]" size={20}/>
                <h3 className="font-black text-lg">å¹´åº¦æœ€æ„›ç´€éŒ„</h3>
              </div>
              <div className="space-y-6">
                <div>
                  <p className="text-[10px] font-black text-[#8B5E3C] uppercase mb-3 tracking-widest">å¹´åº¦æœ€æ„›åº—å®¶ TOP 5</p>
                  <div className="space-y-3">
                    {stats.yTopShops.map(([name, count], idx) => (
                      <div key={name} className="flex justify-between items-center bg-[#F7F1EA]/30 p-3 rounded-2xl">
                        <span className="text-sm font-bold">{idx+1}. {name}</span>
                        <span className="text-xs font-black text-[#8B5E3C]">{count} æ¯</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div>
                  <p className="text-[10px] font-black text-[#8B5E3C] uppercase mb-3 tracking-widest">å¹´åº¦æœ€ä½³çµ„åˆ TOP 5</p>
                  <div className="space-y-3">
                    {stats.yTopConfigs.map(([name, count], idx) => (
                      <div key={name} className="flex justify-between items-start bg-[#F7F1EA]/30 p-3 rounded-2xl">
                        <span className="text-xs font-bold leading-relaxed pr-2">{idx+1}. {name}</span>
                        <span className="text-[10px] font-black text-[#8B5E3C] shrink-0">{count} æ¯</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </section>

            <section className="bg-[#FDFCFB] rounded-[2.5rem] p-7 border border-[#EADBC8] shadow-sm space-y-8">
              <div className="flex items-center gap-3 border-b border-[#F7F1EA] pb-4">
                <Coins className="text-[#8B5E3C]" size={20}/>
                <h3 className="font-black text-lg">ä½ å–æ‰...</h3>
              </div>
              <div className="space-y-8">
                <div className="space-y-3">
                  <div className="flex justify-between items-end">
                    <div className="flex items-center gap-2">
                      <div className="bg-blue-100 p-2 rounded-xl text-blue-600"><Plane size={20}/></div>
                      <div>
                        <p className="font-black text-sm">æ—¥æœ¬ä¾†å›æ©Ÿç¥¨</p>
                        <p className="text-[10px] font-bold opacity-30">å¸‚åƒ¹ç´„ $15,000</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-xs font-black text-blue-600">å·²å–æ‰ {stats.ticketCount} å¼µ</p>
                    </div>
                  </div>
                  <div className="h-4 bg-[#F7F1EA] rounded-full overflow-hidden border border-[#EADBC8]/30 relative">
                    <div className="h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-1000" style={{ width: `${Math.min(100, (parseFloat(stats.ticketCount) % 1) * 100)}%` }}></div>
                  </div>
                </div>
                <div className="space-y-3">
                  <div className="flex justify-between items-end">
                    <div className="flex items-center gap-2">
                      <div className="bg-red-100 p-2 rounded-xl text-red-600"><Gamepad2 size={20}/></div>
                      <div>
                        <p className="font-black text-sm">Nintendo Switch 2</p>
                        <p className="text-[10px] font-bold opacity-30">å¸‚åƒ¹ç´„ $12,000</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-xs font-black text-red-600">å·²å–æ‰ {stats.switchCount} å°</p>
                    </div>
                  </div>
                  <div className="h-4 bg-[#F7F1EA] rounded-full overflow-hidden border border-[#EADBC8]/30 relative">
                    <div className="h-full bg-gradient-to-r from-red-400 to-red-600 transition-all duration-1000" style={{ width: `${Math.min(100, (parseFloat(stats.switchCount) % 1) * 100)}%` }}></div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        )}
      </main>

      <nav className="fixed bottom-0 w-full h-20 bg-[#FDFCFB] border-t border-[#EADBC8] flex justify-around items-center z-50 pb-2 shadow-2xl">
        <button onClick={() => setView('calendar')} className={`flex flex-col items-center gap-1.5 ${view === 'calendar' ? 'text-[#8B5E3C] font-black' : 'text-[#AF8F6F] opacity-50'}`}><CalendarIcon size={26}/><span className="text-[10px] font-black">é£²ç”¨æ—¥æ›†</span></button>
        <button onClick={() => setView('stats')} className={`flex flex-col items-center gap-1.5 ${view === 'stats' ? 'text-[#8B5E3C] font-black' : 'text-[#AF8F6F] opacity-50'}`}><BarChart3 size={26}/><span className="text-[10px] font-black">æ•¸æ“šåˆ†æ</span></button>
      </nav>

      {isModalOpen && (
        <div className="fixed inset-0 z-[100] bg-[#F7F1EA] flex flex-col animate-in slide-in-from-bottom duration-300">
          <div className="bg-[#FDFCFB] px-6 pt-12 pb-5 flex items-center shadow-sm border-b border-[#EADBC8] relative h-28">
            <button onClick={() => setIsModalOpen(false)} className="absolute left-6 p-3 bg-[#F7F1EA] rounded-2xl border border-[#EADBC8]"><ArrowLeft size={24}/></button>
            <div className="flex-1 flex justify-center items-center"><h2 className="font-black text-xl tracking-widest">{selectedDate}</h2></div>
            <button onClick={handleSave} className="absolute right-6 bg-[#8B5E3C] text-white px-5 py-2.5 rounded-2xl font-black shadow-md text-sm">å­˜æª”</button>
          </div>
          <div className="flex-1 overflow-y-auto p-5 space-y-6 pb-64 no-scrollbar">
            {tempList.map((r, i) => {
              const suggestions = (r.shop) ? stats.allHistory.filter(h => h.shop === r.shop).reduce((acc, curr) => {
                const key = `${curr.item}|${curr.price}`;
                if (!ignoredItems.includes(key)) acc[key] = (acc[key] || 0) + 1;
                return acc;
              }, {}) : {};
              const sortedSuggestions = Object.entries(suggestions).sort((a,b)=>b[1]-a[1]).slice(0, 5).map(e => ({ item: e[0].split('|')[0], price: e[0].split('|')[1], rawKey: e[0] }));

              return (
                <div key={i} onClick={() => setActiveInputIdx(i)} className={`bg-[#FDFCFB] rounded-[2.5rem] p-7 space-y-6 border-2 transition-all ${activeInputIdx === i ? 'border-[#8B5E3C]' : 'border-[#EADBC8]'}`}>
                  <div className="flex justify-between items-center">
                    <span className="text-[11px] font-black text-[#8B5E3C] opacity-40 uppercase">é£²å“ 0{i+1}</span>
                    <div className="flex items-center gap-1.5">
                        <button onClick={(e) => { e.stopPropagation(); setEditMemoryMode(!editMemoryMode); }} className={`p-2 rounded-xl transition-all shadow-sm ${editMemoryMode ? 'bg-[#432818] text-white' : 'bg-[#F7F1EA] text-[#432818] border border-[#EADBC8]'}`}>
                            <Settings2 size={16}/>
                        </button>
                        {/* å›å¾©æŒ‰éˆ•æ”¾å›åƒåœ¾æ¡¶æ—é‚Š */}
                        <button onClick={(e) => { e.stopPropagation(); setShowRestoreModal(true); }} className="text-[#AF8F6F] p-2 ml-1"><RotateCcw size={20}/></button>
                        <button onClick={(e) => { e.stopPropagation(); setTempList(tempList.filter((_, idx) => idx !== i)); }} className="text-red-400 p-2"><Trash2 size={20}/></button>
                    </div>
                  </div>
                  
                  <div className="space-y-5">
                    <div className="space-y-3">
                      <p className="text-[10px] font-black text-[#8B5E3C] uppercase px-1">åº—å®¶åç¨±</p>
                      <input className="w-full bg-[#F7F1EA] rounded-2xl px-5 h-14 text-sm font-black border border-[#EADBC8]" value={r.shop || ""} onChange={e => { const nl = [...tempList]; nl[i].shop = e.target.value; setTempList(nl); }} placeholder="åº—å®¶..." />
                      <div className="flex flex-wrap gap-2 pt-1">
                        {stats.topShops.map(s => (
                          <div key={s} className="relative">
                            <button onClick={() => { if(!editMemoryMode) { const nl = [...tempList]; nl[i].shop = s; setTempList(nl); } }} className={`px-3 py-1.5 rounded-full text-[10px] font-black border transition-all ${r.shop === s ? 'bg-[#8B5E3C] text-white' : 'bg-white text-[#AF8F6F]'}`}>
                              {s}
                            </button>
                            {editMemoryMode && (
                                <button onClick={(e) => { e.stopPropagation(); handleIgnore(s); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg"><X size={10} strokeWidth={4} /></button>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="space-y-3">
                      <p className="text-[10px] font-black text-[#8B5E3C] uppercase px-1">å“é …åç¨±</p>
                      <input className="w-full bg-[#F7F1EA] rounded-2xl px-5 h-14 text-sm font-black border border-[#EADBC8]" value={r.item || ""} onChange={e => { const nl = [...tempList]; nl[i].item = e.target.value; setTempList(nl); }} placeholder="å–ä»€éº¼å‘¢..." />
                      {sortedSuggestions.length > 0 && (
                        <div className="space-y-2 pt-1">
                          <p className="text-[9px] font-bold text-[#AF8F6F] px-1 italic">å¸¸ç”¨ï¼š</p>
                          <div className="flex flex-wrap gap-2">
                            {sortedSuggestions.map((s, idx) => (
                              <div key={idx} className="relative">
                                <button onClick={() => { 
                                  if(!editMemoryMode) {
                                    const nl = [...tempList]; 
                                    nl[i].item = s.item; 
                                    nl[i].price = s.price; 
                                    const lastConfig = findLastConfigForItem(r.shop, s.item, s.price);
                                    nl[i].sugar = lastConfig.sugar;
                                    nl[i].ice = lastConfig.ice;
                                    setTempList(nl); 
                                  }
                                }} className="bg-white border border-[#EADBC8]/50 px-3 py-2 rounded-xl text-[11px] font-bold">
                                  {s.item} (${s.price})
                                </button>
                                {editMemoryMode && (
                                    <button onClick={(e) => { e.stopPropagation(); handleIgnore(s.rawKey); }} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white rounded-full p-1 shadow-lg"><X size={10} strokeWidth={4} /></button>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="flex flex-col gap-3">
                      <p className="text-[10px] font-black text-[#8B5E3C] uppercase px-1">é‡‘é¡èˆ‡æŠ˜æ‰£</p>
                      <button onClick={() => setShowKeypad(showKeypad === i ? null : i)} className={`w-full rounded-[2rem] h-20 flex items-center px-8 font-black text-4xl italic border transition-all ${showKeypad === i ? 'bg-[#8B5E3C] text-white' : 'bg-[#F7F1EA] border-[#EADBC8]'}`}>
                        <span className="opacity-30 mr-2 text-xl font-bold">$</span> {r.isGift ? 0 : (r.isEco ? Math.max(0, (parseFloat(r.price)||0)-5) : (parseFloat(r.price)||0))} <ChevronDown size={24} className="ml-auto opacity-30" />
                      </button>
                      <div className="flex gap-3">
                        <button onClick={() => { const nl = [...tempList]; nl[i].isEco = !nl[i].isEco; setTempList(nl); }} className={`flex-1 h-14 rounded-full font-black text-xs flex items-center justify-center gap-2 ${r.isEco ? 'bg-green-500 text-white shadow-md' : 'bg-white text-[#AF8F6F] border'}`}><Leaf size={16}/>ç’°ä¿æ¯ -5</button>
                        <button onClick={() => { const nl = [...tempList]; nl[i].isGift = !nl[i].isGift; setTempList(nl); }} className={`flex-1 h-14 rounded-full font-black text-xs flex items-center justify-center gap-2 ${r.isGift ? 'bg-yellow-500 text-white shadow-md' : 'bg-white text-[#AF8F6F] border'}`}><Gift size={16}/>è«‹å®¢ ğŸ™Œ</button>
                      </div>
                    </div>

                    {showKeypad === i && (
                      <div className="grid grid-cols-4 gap-2 bg-[#F7F1EA] p-5 rounded-[2rem] border border-[#EADBC8]">
                        {[1, 2, 3, 'clear', 4, 5, 6, 'del', 7, 8, 9, 0].map(k => (
                          <button key={k} onClick={() => {
                            const nl = [...tempList];
                            let curr = nl[i].price?.toString() || "";
                            if (k === 'del') curr = curr.slice(0, -1);
                            else if (k === 'clear') curr = "";
                            else curr += k;
                            nl[i].price = curr;
                            setTempList(nl);
                          }} className="h-14 bg-white rounded-2xl font-black text-lg text-[#8B5E3C] shadow-sm">{k === 'clear' ? 'C' : k === 'del' ? <Delete size={20} className="mx-auto"/> : k}</button>
                        ))}
                      </div>
                    )}

                    <div className="space-y-3.5">
                      <p className="text-[10px] font-black text-[#8B5E3C] uppercase px-1">ç”œåº¦å†°å¡Š</p>
                      <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                        {SUGAR_OPTIONS.map(s => <button key={s} onClick={() => { const nl = [...tempList]; nl[i].sugar = s; setTempList(nl); }} className={`shrink-0 px-4 py-3 rounded-2xl text-[11px] font-black border transition-all ${r.sugar === s ? 'bg-[#8B5E3C] text-white shadow-md' : 'bg-[#F7F1EA] text-[#AF8F6F]'}`}>{s}</button>)}
                      </div>
                      <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                        {ICE_OPTIONS.map(ic => <button key={ic} onClick={() => { const nl = [...tempList]; nl[i].ice = ic; setTempList(nl); }} className={`shrink-0 px-4 py-3 rounded-2xl text-[11px] font-black border transition-all ${r.ice === ic ? 'bg-[#8B5E3C] text-white shadow-md' : 'bg-[#F7F1EA] text-[#AF8F6F]'}`}>{ic}</button>)}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
            <button onClick={() => setTempList([...tempList, { shop: "", item: "", price: "", sugar: "ç„¡ç³–", ice: "å»å†°", isEco: false, isGift: false }])} className="w-full py-10 border-2 border-dashed border-[#EADBC8] rounded-[3rem] text-[#8B5E3C] font-black flex flex-col items-center gap-2 bg-[#FDFCFB]"><Plus size={32}/><span className="text-[11px] uppercase">æ–°å¢ç´€éŒ„</span></button>
          </div>
        </div>
      )}

      {showRestoreModal && (
          <div className="fixed inset-0 z-[200] bg-black/40 flex items-center justify-center p-6 backdrop-blur-sm">
              <div className="bg-[#FDFCFB] w-full max-w-md rounded-[2.5rem] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden border border-[#EADBC8]">
                  <div className="p-6 border-b border-[#F7F1EA] flex justify-between items-center">
                      <h3 className="font-black text-lg text-[#432818]">å¾©åŸé¸é …</h3>
                      <button onClick={() => setShowRestoreModal(false)} className="p-2 bg-white rounded-full border border-[#EADBC8]"><X size={20}/></button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 space-y-3 bg-[#F7F1EA]/30">
                      {ignoredItems.map((id, idx) => (
                        <button key={idx} onClick={() => handleRestoreItem(id)} className="w-full bg-white p-4 rounded-2xl border border-[#EADBC8] flex items-center justify-between shadow-sm">
                            <span className="text-xs font-bold text-[#432818] truncate">{id.includes('|') ? id.split('|')[0] : id}</span>
                            <RotateCcw size={16} className="text-[#AF8F6F] ml-2"/>
                        </button>
                      ))}
                  </div>
              </div>
          </div>
      )}

      <style>{`
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-inset { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        * { -webkit-tap-highlight-color: transparent; }
      `}</style>
    </div>
  );
}  </code></pre>
</body>
</html>
